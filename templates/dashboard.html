{% extends "base.html" %}

{% block content %}
<style>
    .stats-card {
        height: 300px;
    }
</style>

<h1>Dashboard</h1>
<p>Welcome, {{ session['username'] }}!</p>

{% if user_role == 'admin' %}
    <h2><strong>Admin Dashboard</strong></h2>

    <!-- System Stats Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>System Stats</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="cpu-usage" class="stats-card"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="memory-usage" class="stats-card"></div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div id="disk-usage" class="stats-card"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="network-usage" class="stats-card"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Endpoint Management -->
    <h3>API Endpoint Management</h3>

    <!-- Create New API Endpoint -->
    <h5>Create New API Endpoint</h5>
    <form action="{{ url_for('dashboard') }}" method="POST" class="mb-4">
        <input type="hidden" name="action" value="create_endpoint">
        <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>
        <div class="mb-3">
            <label for="endpoint" class="form-label">Endpoint URL</label>
            <input type="text" class="form-control" id="endpoint" name="endpoint" required>
        </div>
        <div class="mb-3">
            <label for="method" class="form-label">HTTP Method</label>
            <select class="form-select" id="method" name="method" required>
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Create API Endpoint</button>
    </form>

    <!-- Existing API Endpoints -->
    <h4>Existing API Endpoints</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Endpoint URL</th>
                <th>Method</th>
                <th>Description</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for endpoint in api_endpoints %}
            <tr>
                <td>{{ endpoint['name'] }}</td>
                <td>{{ endpoint['endpoint'] }}</td>
                <td>{{ endpoint['method'] }}</td>
                <td>{{ endpoint['description'] }}</td>
                <td>
                    <form action="{{ url_for('dashboard') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this API endpoint?');">
                        <input type="hidden" name="action" value="delete_endpoint">
                        <input type="hidden" name="endpoint_id" value="{{ endpoint['id'] }}">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endif %}

<!-- Include Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
    let inactivityTimer;
    let lastActivityTime = Date.now();
    const inactivityTime = 1 * 60 * 1000; // 2 minutes in milliseconds
    const updateInterval = 30 * 1000; // 30 seconds in milliseconds
    
    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(checkInactivity, inactivityTime);
        lastActivityTime = Date.now();
    }
    
    function checkInactivity() {
        if (Date.now() - lastActivityTime >= inactivityTime) {
            logout();
        } else {
            inactivityTimer = setTimeout(checkInactivity, inactivityTime - (Date.now() - lastActivityTime));
        }
    }
    
    function logout() {
        window.location.href = '/logout';
    }
    
    function updateServerActivity() {
        fetch('/update_activity', { method: 'POST' });
    }
    
    function checkSession() {
        fetch('/check_session')
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    logout();
                }
            });
    }
    
    document.addEventListener('mousemove', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);
    
    // Initial setup
    resetInactivityTimer();
    
    // Periodically update server and check session
    setInterval(() => {
        updateServerActivity();
        checkSession();
    }, updateInterval);

    // System stats functions
    let cpuChart, memoryChart, diskChart, networkChart;

function fetchSystemStats() {
    fetch('/admin/system_stats')
        .then(response => response.json())
        .then(data => {
            updateSystemStats(data);
        })
        .catch(error => {
            console.error('Error fetching system stats:', error);
        });
}

function updateSystemStats(data) {
    // Convert Unix timestamps to readable format
    const formattedTimestamps = data.timestamps.map(timestamp => 
        new Date(timestamp * 1000).toLocaleTimeString()
    );

    // CPU Usage
    var cpuTrace = {
        labels: Object.keys(data.cpu_usage),
        values: Object.values(data.cpu_usage),
        type: 'pie',
        name: 'CPU Usage'
    };
    var cpuLayout = {
        title: 'CPU Usage'
    };
    Plotly.newPlot('cpu-usage', [cpuTrace], cpuLayout);

    // Memory Usage
    var memoryTrace = {
        labels: Object.keys(data.memory_usage),
        values: Object.values(data.memory_usage),
        type: 'pie',
        name: 'Memory Usage'
    };
    var memoryLayout = {
        title: 'Memory Usage'
    };
    Plotly.newPlot('memory-usage', [memoryTrace], memoryLayout);

    // Disk Usage
    var diskTrace = {
        labels: Object.keys(data.disk_usage),
        values: Object.values(data.disk_usage),
        type: 'pie',
        name: 'Disk Usage'
    };
    var diskLayout = {
        title: 'Disk Usage'
    };
    Plotly.newPlot('disk-usage', [diskTrace], diskLayout);

    // Network Usage
    if (!networkChart) {
        var networkTrace = {
            x: formattedTimestamps,
            y: data.network_usage,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Network Usage'
        };
        var networkLayout = {
            title: 'Network Usage',
            yaxis: {title: 'MB'}
        };
        networkChart = Plotly.newPlot('network-usage', [networkTrace], networkLayout);
    } else {
        Plotly.update('network-usage', {
            x: [formattedTimestamps],
            y: [data.network_usage]
        });
    }
}

// Update system stats every 10 seconds
setInterval(fetchSystemStats, 10000);

// Initial fetch of system stats
fetchSystemStats();
</script>

{% endblock %}